<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ุชุญูู ูู ุงูููุฒุงู</title>
  <!-- ุชุถููู Bootstrap -->

  <!-- Bootstrap JS (ูุน Popper.js) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* ุฃููุงุท ุฅุถุงููุฉ */
    body {
      padding-top: 56px;
      /* ูุชุฌูุจ ุงูุชุฏุงุฎู ูุน ุดุฑูุท ุงูุนููุงู */
    }

    .sidebar {
      height: calc(100vh - 56px);
      overflow-y: auto;
    }

    .content {
      min-height: calc(100vh - 56px);
    }
  </style>
  <style>
    /* body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; } */
    .button2 {
      font-size: 20px;
      padding: 12px 30px;
      margin: 10px;
      cursor: pointer;
      border: none;
      border-radius: 6px;
    }

    .on {
      background: green;
      color: #fff;
    }

    .off {
      background: red;
      color: #fff;
    }
  </style>
</head>

<body>
  <!-- ุดุฑูุท ุงูุนููุงู -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
    <div class="container-fluid">
      <button class="btn btn-outline-light me-4" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu"
        aria-controls="sidebarMenu">
        โฐ ุงููุงุฆูุฉ

        <!-- ุฅุถุงูุฉ ุนูุงูุฉ ูุชุฏูู ุงูุจูุงูุงุช -->
        <small id="streamIndicator" style="display: none;">

          <span class="badge bg-danger">๐ด</span>
          <span id="online-indicator"></span>
        </small>
      </button>
      <a class="navbar-brand" href="#">ููุฒุงู ุดูุดุงู</a>



      <p id="status">ุฌุงุฑู ุชุญููู ุงูุญุงูุฉ...</p>
    </div>
  </nav>
  <script>
    async function setPrint(status) {
      await fetch(`/set-print/${status}`);
      loadStatus();
    }

    async function loadStatus() {
      const res = await fetch("/get-print");
      const data = await res.json();
      document.getElementById("status").innerText =
        data.print === 1 ? "โ ุงูุทุจุงุนุฉ ุงูุญุฑุงุฑูู" : "โ ุงูุทุจุงุนุฉ ุงูุญุฑุงุฑูู";
    }

    loadStatus();
    setInterval(loadStatus, 3000); // ูุญุฏุซ ุงูุญุงูุฉ ูู 3 ุซูุงูู
  </script>
  <!-- ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ (Offcanvas) -->
  <div class="offcanvas offcanvas-start bg-light" tabindex="-1" id="sidebarMenu" aria-labelledby="sidebarMenuLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="sidebarMenuLabel">ุงูุฃูุงูุฑ</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <ul class="nav flex-column">
        <li class="nav-item">
          <button class="btn btn-primary w-100 mb-2" onclick="sendCommand('XN2')">ูุฑุงุกุฉ ุงููุฒู ุงูุตุงูู</button>
        </li>
        <li class="nav-item">
          <button class="btn btn-primary w-100 mb-2" onclick="sendCommand('KZERO')">ุชุตููุฑ ุงูููุฒุงู</button>
        </li>
        <li class="nav-item">
          <button class="btn btn-primary w-100 mb-2" onclick="sendCommand('KTARE')">ุชูููุฐ ุงูุชุงุฑู</button>
        </li>
        <li class="nav-item">
          <button class="btn btn-primary w-100 mb-2" onclick="sendCommand('KPRINT')">ุทุจุงุนุฉ ุงูุชุฐูุฑุฉ</button>
        </li>
        <li class="nav-item">
          <button class="btn btn-primary w-100 mb-2" onclick="sendCommand('SX')">ุชูุนูู ุงูุจุซ ุงููุจุงุดุฑ </button>
        </li>
        <li class="nav-item">
          <button class="btn btn-primary w-100 mb-2" onclick="sendCommand('EX')">ุงููุงู ุงูุจุซ ุงููุจุงุดุฑ </button>
        </li>

        <button class="on button2" onclick="setPrint(1)">ุชุดุบูู ุงูุทุจุงุนุฉ ุงูุญุฑุงุฑูู</button>
        <button class="off button2" onclick="setPrint(0)">ุฅููุงู ุงูุทุจุงุนุฉุงูุญุฑุงุฑูู</button>
        <!-- <button class="btn btn-info w-5 " onclick="sendCommand('SX')">ุชูุนูู</button>
      <button class="btn btn-info w-5 " onclick="sendCommand('EX')">ุงููุงู</button> -->
        <button type="button" id="streamButton" class="btn btn-primary" onclick="toggleStream()">Start
          Stream</button>
      </ul>
    </div>
  </div>

  <!-- ุงููุญุชูู ุงูุฑุฆูุณู -->
  <main class="container mt-4">
    <!-- <h2>ุงูุฑุฏ ูู ุงูุฌูุงุฒ:</h2> -->
    <div i class="alert alert-secondary">

      <h1 id="response">
        --
      </h1>


    </div>
    <h3 id="response11">
      --
    </h3>
    <!-- ุฅุถุงูุฉ ุนูุงูุฉ ูุชุฏูู ุงูุจูุงูุงุช
    <div id="streamIndicator" style="display: none;">
     
      <span class="badge bg-danger">๐ด</span> <small>ุชุฏูู ุงูุจูุงูุงุช </small>
      <span id="online-indicator"></span>
    </div> -->
    <!-- ููุญุฉ ุงูููุงุชูุญ ุงูุชุญูู -->
    <div class="container text-center">
      <div class="row align-items-start">
        <div class="col">
          <button class="btn btn-info w-100 mb-2" onclick="sendCommand('KPRINT')">PRINT</button>
        </div>
        <!-- <div class="col">
          <button class="btn btn-info w-100 mb-2" onclick="sendCommand('KUNITS')">UNITS</button>
        </div> -->
        <div class="col">
          <button class="btn btn-info w-100 mb-2" onclick="sendCommand('KTARE')">TARE</button>
        </div>
        <div class="col">
          <button class="btn btn-info w-100 mb-2" onclick="sendCommand('KZERO')">ZERO</button>
        </div>
        <div class="col">
          <button class="btn btn-info w-100 mb-2" onclick="sendCommand('Kid')">id </button>
        </div>
      </div>
    </div>



    <!-- ููุญุฉ ุงูููุงุชูุญ ุงูุฑูููุฉ -->
    <div class="container mt-4">
      <div class="row justify-content-center">

        <!-- ููุญุฉ ุงูููุงุชูุญ -->
        <div class="col-md-8">
          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-primary w-25" onclick=" sendCommand('K1')">1</button>
            <button class="btn btn-primary w-25" onclick=" sendCommand('K2')">2</button>
            <button class="btn btn-primary w-25" onclick=" sendCommand('K3')">3</button>
            <button class="btn btn-primary w-25" onclick=" sendCommand('K4')">4</button>
            <button class="btn btn-primary w-25" onclick=" sendCommand('K5')">5</button>
            <button class="btn btn-primary w-25" onclick=" sendCommand('K6')">6</button>
            <button class="btn btn-primary w-25" onclick=" sendCommand('K7')">7</button>
            <button class="btn btn-primary w-25" onclick=" sendCommand('K8')">8</button>
            <button class="btn btn-primary w-25" onclick=" sendCommand('K9')">9</button>
            <button class="btn btn-primary w-25" onclick=" sendCommand('K0')">0</button>
            <button class="btn btn-danger  w-25" onclick=" sendCommand('KCLR')">ูุณุญ</button>
            <button class="btn btn-success w-25" onclick="sendCommand('KENTER')">ENTER</button>
            <button class="btn btn-success w-25" onclick="sendCommand('KDISPTARE')">DISPLAY</button>
            <button class="btn btn-success w-25" onclick="sendCommand('KESCAPE')">ESCAPE</button>
            <button class="btn btn-success w-25" onclick="sendCommand('KUNITS')">UNITS</button>

          </div>
        </div>

        <!-- ุงูุจููุณ ุจุฌุงูุจ ููุญุฉ ุงูููุงุชูุญ -->
        <div class="col-md-4">


          <div class="input-group mb-3">
            <input list="types" id="type" class="form-control" placeholder=" ุงูููุน">
            <datalist id="types">
              <option value="ุฃุฑุฒ">
              <option value="ุบูุฉ">
              <option value="ุชุจู">
              <option value="ุฎุดุจ">
              <option value="ูุจ">
              <option value="ููู">
            </datalist>

            <input list="customers" id="customer" type="text" placeholder="ุงูุนููู" class="form-control">
            <datalist id="customers">
              <option value="ุงูุญุงุฌ ุฎุงูุฏ ุนุจุฏ ุงูุณูุงู">
              <option value="ุนูุงุฏ ููุญ">
              <option value="ูุญูุฏ ุงูุตูุฏูุงูู">
              <option value="ูุญูุฏ ููุตูุฑ">
              <option value="ูุญููุฏ ูุตูุฑ">
              <option value="ูุงูู ุนุจุฏ ุงูุจุงุนุซ">
              <option value="ุงูุดุญุงุช ุนุจุฏ ุงูุจุงุนุซ">
              <option value="ุงุญูุฏุนูู ">
              <option value="ุนูู ูุญุฑูุณ ">
            </datalist>
         <button class="btn btn-outline-danger" type="button" onclick="clearFields()">โ</button>
</div>

<script>
  function clearFields() {
    document.getElementById('type').value = '';
    document.getElementById('customer').value = '';
  }
</script>

          <div class="input-group mb-3">
            <input id="edpInput" type="text" placeholder="EDP input hereโฆ" class="form-control">
            <div class="input-group-append">
              <!-- ุฒุฑ "X" ูุญุฐู ุงููุญุชูู -->
              <button type="button" class="btn btn-outline-secondary" onclick="clearInput('edpInput')">โ</button>
            </div>
            <div class="input-group-prepend">
              <!-- ุฒุฑ ุงูุฅุฑุณุงู -->
              <button type="button" class="btn btn-danger" onclick="sendTextCommand()">Send</button>
            </div>
          </div>
          <!-- <div class="input-group mb-3">
            <button type="button" id="streamButton" class="btn btn-primary" onclick="toggleStream()">Start
              Stream</button>
          </div> -->

          <script>
            let isStreaming = false; // ูุชุบูุฑ ูุชุญุฏูุฏ ูุง ุฅุฐุง ูุงู ุงูุฅุฑุณุงู ูุดุทูุง ุฃู ูุง
            let streamInterval; // ูุชุบูุฑ ูุชุฎุฒูู ูุนุฑู ุงููุคูุช
            let stopTimeout; // ูุชุบูุฑ ูุชุฎุฒูู ูุนุฑู ุงููุคูุช ุงูุฎุงุต ุจุงูุชููู ุงูุชููุงุฆู

            function toggleStream() {
              const button = document.getElementById("streamButton");

              if (!isStreaming) {
                // ุจุฏุก ุงูุฅุฑุณุงู ุงููุณุชูุฑ ููุฃูุฑ ZZ
                isStreaming = true;
                button.textContent = "Stop Stream P"; // ุชุบููุฑ ูุต ุงูุฒุฑ ุฅูู "Stop Stream"

                // ุฅุฑุณุงู ุงูุฃูุฑ ZZ ูู 1000 ูููู ุซุงููุฉ (1 ุซุงููุฉ)
                streamInterval = setInterval(() => {
                  sendCommand("p");//zz or p
                }, 1000);
                // ุฅููุงู ุงูุฅุฑุณุงู ุชููุงุฆููุง ุจุนุฏ ุฏูููุฉ ูุงุญุฏุฉ (60000 ูููู ุซุงููุฉ)
                stopTimeout = setTimeout(() => {
                  stopStreaming(); // ุฅููุงู ุงูุฅุฑุณุงู ุจุนุฏ ุงูุชูุงุก ุงูููุช
                }, 20000); // 60000 ูููู ุซุงููุฉ = ุฏูููุฉ ูุงุญุฏุฉ
              } else {
                // ุฅููุงู ุงูุฅุฑุณุงู ุงููุณุชูุฑ ููุฃูุฑ ZZ
                isStreaming = false;
                button.textContent = "Start Stream"; // ุชุบููุฑ ูุต ุงูุฒุฑ ุฅูู "Start Stream"

                // ุฅููุงู ุงููุคูุช
                clearInterval(streamInterval);
              }
            }
            function stopStreaming() {
              const button = document.getElementById("streamButton");

              if (isStreaming) {
                isStreaming = false;
                button.textContent = "Start Stream"; // ุชุบููุฑ ูุต ุงูุฒุฑ ุฅูู "Start Stream"

                // ุฅููุงู ุงููุคูุช ุงูุฏูุฑู
                clearInterval(streamInterval);

                // ูุณุญ ูุคูุช ุงูุชููู ุงูุชููุงุฆู ุฅุฐุง ูุงู ููุฌูุฏูุง
                clearTimeout(stopTimeout);
              }
            }

            // function sendCommand(command) {
            //   // ููุง ููููู ุฅุถุงูุฉ ููุทู ุฅุฑุณุงู ุงูุฃูุฑ ุฅูู ุงูุฌูุงุฒ ุนุจุฑ ูููุฐ EDP ุฃู ุฃู ุทุฑููุฉ ุฃุฎุฑู
            //   console.log("Sending command:", command);


            // }
          </script>
          <script>
            // ุฏุงูุฉ ูุญุฐู ูุญุชูู ุงูุญูู
            function clearInput(X) {
              document.getElementById(X).value = "";
            }
          </script>

          <div id="response1" class="border rounded p-3 overflow-auto "
            style="height: calc(1.5em * 10); white-space: pre-line; text-align: left; background-color: #000; color: #fff;">
            <!-- ุงูุจูุงูุงุช ูุชุธูุฑ ููุง -->
          </div>
        </div>

      </div>
    </div>


    <div class="d-flex justify-content-center gap-3">
      <a href="table1.html" class="btn btn-primary">ุฌุฏูู ุงูุจูุงูุงุช</a>
      <a href="table2.html" class="btn btn-success">ุฌุฏูู ุงูุชุฐุงูุฑ</a>
    </div>












    <!-- ุนูุตุฑ ุงูุตูุช -->
    <audio id="audioPlayer" controls style="display:none;"></audio>
  </main>

  <!-- ุชุถููู ููุชุจุฉ Socket.IO -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // ุฅุฑุณุงู ุฃูุฑ ุฅูู ุงูุฎุงุฏู
    function sendTextCommand() {
      var inputValue = document.getElementById("edpInput").value;

      fetch(`/send-command?command=${inputValue}`)
        .then(response => response.text())
        .then(data => {
        })
        .catch(error => {
          console.error('ุญุฏุซ ุฎุทุฃ:', error);
        });
    }
    function sendCommand(command) {
      if (!isStreaming) {
        toggleStream();
      }
      const typeInput = document.getElementById('type');
      const customerInput = document.getElementById('customer');

      const type = typeInput.value;
      const customer = customerInput.value;

      fetch(`/send-command?command=${command}&&type=${type}&&customer=${customer}`)
        .then(response => response.text())
        .then(data => {
        })
        .catch(error => {
          console.error('ุญุฏุซ ุฎุทุฃ:', error);
        });

      if (command == 'Kid' || command == 'KPRINT') {
        // fetchData();
        // ุฅุนุงุฏุฉ ุถุจุท ุงูุญููู
        typeInput.value = '';
        customerInput.value = '';
      }

    }
    const streamIndicator = document.getElementById('streamIndicator');
    let count = 0
    // ุงุณุชูุจุงู ุงูุฑุฏ ุงููุจุงุดุฑ ูู ุงูุฌูุงุฒ ุนุจุฑ WebSocket
    socket.on('response', (data) => {

      if (data.length == 11 || data.length == 12) {
        document.getElementById('response').innerText = data;

        // ุฅุธูุงุฑ ุนูุงูุฉ ุงูุชุฏูู ุฅุฐุง ูุงูุช ููุงู ุจูุงูุงุช ูุงุฏูุฉ
        count++;
        // console.log(count);
        if (count == 80) {
          count = 0;
          streamIndicator.style.visibility = 'hidden';
          streamIndicator.style.opacity = '0'; // ุชุฌุฑุจุฉ ุฅุถุงูุฉ opacity
        } else if (count >= 50) {
          streamIndicator.style.display = 'block'; // ุฅุธูุงุฑ
          streamIndicator.style.visibility = 'visible';
          streamIndicator.style.opacity = '1'; // ุชุฌุฑุจุฉ ุฅุถุงูุฉ opacity
        }
      } else {



        document.getElementById('response1').innerText += " " + data + "\n";
        console.log(data)
        if (data.slice(-2).toUpperCase() === "NE") {
          document.getElementById('response11').innerText = data;
        }


        const box = document.getElementById('response1');
        box.scrollTop = box.scrollHeight; // ูุนูู ุณูุฑูู ุชููุงุฆู ููุฃุณูู   
      }


    });







    function sendNumericCommand() {

      // ุฅุฑุณุงู ุงูุฃูุฑ ูุน ุงููููุฉ ุงูุฑูููุฉ
      fetch(`/send-command?command=KSETTARE=${numericValue}`)
        .then(response => response.text())
        .then(data => {

        })
        .catch(error => {
          console.error('ุญุฏุซ ุฎุทุฃ:', error);
        });

    }

    // ุงูุญุตูู ุนูู ุนูุตุฑ ุงูุตูุช
    const audioPlayer = document.getElementById('audioPlayer');
    // const statusElement = document.getElementById('status');

    // ุงุณุชูุงุน ุฅูู ุฅุดุงุฑุงุช ุชุดุบูู ุงูุตูุช ูู ุงูุฎุงุฏู
    socket.on('play-audio', (fileName) => {
      const audioUrl = `/audio/${fileName}`; // ุงููุณุงุฑ ุฅูู ุงูููู ุงูุตูุชู
      // statusElement.textContent = `ุฌุงุฑู ุชุดุบูู: ${fileName}`;

      // ุชุญุฏูุซ ูุตุฏุฑ ุงูุตูุช ูุชุดุบููู
      audioPlayer.src = audioUrl;
      audioPlayer.play();
    });

    // ุชุญุฏูุซ ุญุงูุฉ ุงููุงุฌูุฉ ุนูุฏ ุงุณุชูุงู ุจูุงูุงุช ุฌุฏูุฏุฉ
    // socket.on('response', (data) => {
    //     // console.log('ุจูุงูุงุช ูุณุชููุฉ:', data);
    //     statusElement.textContent = `ุงูุจูุงูุงุช ุงููุณุชููุฉ: ${data}`;
    // });
    socket.on('responseID', (data) => {
      offset = 0;
      fetchData("ok");
    });

  </script>
</body>

</html>